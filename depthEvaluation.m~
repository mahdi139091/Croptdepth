clc;
clear;

%% cropping input images

visualize=true;

datasets=['RedWeb', 'DeepLens', 'IBMS1'];


IBMS1_datadir_cropped     = 'results/RedWeb/Depth_est_cropped'; 
IBMS1_cropped_datadir     = 'results/RedWeb/Cropped_Estimation';
IBMS1_gtdir       = 'img/RedWeb/Depth_cropped'; 

DeepLens_datadir_cropped     = 'results/DeepLens/Depth_est_cropped';  
DeepLens_cropped_datadir     = 'results/DeepLens/Cropped_Estimation';
DeepLens_gtdir       = 'img/DeepLens/Depth_cropped'; 

resultsdir  = 'results'; %the directory for dumping results

IBMS1_gtlist=dir(sprintf('%s/*.png', IBMS1_gtdir));
IBMS1_img_croppedlist = dir(sprintf('%s/*.png', IBMS1_datadir_cropped));
IBMS1_cropped_imagelist=dir(sprintf('%s/*.png', IBMS1_cropped_datadir));

DeepLens_gtlist=dir(sprintf('%s/*.png', DeepLens_gtdir));
DeepLens_img_croppedlist = dir(sprintf('%s/*.png', DeepLens_datadir_cropped));
DeepLens_cropped_imagelist=dir(sprintf('%s/*.png', DeepLens_cropped_datadir));

IBMS1_RMSE_error_cropped=[];
IBMS1_RMSE_cropped_error=[];
IBMS1_PSNR_error_cropped=[];
IBMS1_PSNR_cropped_error=[];
IBMS1_SSIM_error_cropped=[];
IBMS1_SSIM_cropped_error=[];
IBMS1_MI_error_cropped=[];
IBMS1_MI_cropped_error=[];

DeepLens_RMSE_error_cropped=[];
DeepLens_RMSE_cropped_error=[];
DeepLens_PSNR_error_cropped=[];
DeepLens_PSNR_cropped_error=[];
DeepLens_SSIM_error_cropped=[];
DeepLens_SSIM_cropped_error=[];
DeepLens_MI_error_cropped=[];
DeepLens_MI_cropped_error=[];

%% IBMS1
for i = 1:numel(IBMS1_gtlist)
    
    % IBMS1 Load Data
    IBMS1_gt = double(imread(sprintf('%s/%s', IBMS1_gtdir, IBMS1_gtlist(i).name)));
    IBMS1_gtNorm = 65535 - IBMS1_gt;
    %%IBMS1_gtNorm = rescale(IBMS1_gtNorm,0,65535);
    
    IBMS1_est_cropped = double(imread(sprintf('%s/%s', IBMS1_datadir_cropped, IBMS1_img_croppedlist(i).name)));
    IBMS1_est_cropped_Norm = IBMS1_est_cropped;
    %IBMS1_est_cropped_Norm = rescale(IBMS1_est_cropped_Norm,0,65535);
   % IBMS1_est_cropped_Norm = mapper(IBMS1_est_cropped_Norm,IBMS1_gtNorm);
    IBMS1_gtNorm = mapper(IBMS1_gtNorm,IBMS1_est_cropped_Norm);

    IBMS1_cropped_est = double(imread(sprintf('%s/%s', IBMS1_cropped_datadir, IBMS1_cropped_imagelist(i).name)));
    IBMS1_cropped_est_Norm = IBMS1_cropped_est;
    %IBMS1_cropped_est_Norm = rescale(IBMS1_cropped_est_Norm,0,65535);
    IBMS1_cropped_est_Norm = mapper(IBMS1_cropped_est_Norm,IBMS1_est_cropped_Norm);
    
    % IBMS1 Error
    
    % RMSE
    IBMS1_est_cropped_RMSE_error=immse(IBMS1_est_cropped_Norm,IBMS1_gtNorm);
    IBMS1_cropped_est_RMSE_error=immse(IBMS1_cropped_est_Norm,IBMS1_gtNorm);
    
    IBMS1_est_cropped_RMSE_error_image=IBMS1_est_cropped_Norm-IBMS1_gtNorm;
    IBMS1_cropped_est_RMSE_error_image=IBMS1_cropped_est_Norm-IBMS1_gtNorm;

    IBMS1_RMSE_error_cropped =[IBMS1_RMSE_error_cropped,abs(IBMS1_est_cropped_RMSE_error)];
    IBMS1_RMSE_cropped_error =[IBMS1_RMSE_cropped_error,abs(IBMS1_cropped_est_RMSE_error)];
    
    %PSNR
    
    IBMS1_est_cropped_PSNR_error = psnr(uint16(IBMS1_est_cropped_Norm),uint16(IBMS1_gtNorm));
    IBMS1_cropped_est_PSNR_error = psnr(uint16(IBMS1_cropped_est_Norm),uint16(IBMS1_gtNorm));
    
    IBMS1_PSNR_error_cropped=[IBMS1_PSNR_error_cropped,IBMS1_est_cropped_PSNR_error];
    IBMS1_PSNR_cropped_error=[IBMS1_PSNR_cropped_error,IBMS1_cropped_est_PSNR_error];

    % SSIM
    
    [IBMS1_est_cropped_SSIM_error,IBMS1_est_cropped_SSIM_map] = ssim(uint16(IBMS1_est_cropped),uint16(IBMS1_gt));
    [IBMS1_cropped_est_SSIM_error,IBMS1_cropped_est_SSIM_map] = ssim(uint16(IBMS1_cropped_est),uint16(IBMS1_gt));
    
%     IBMS1_est_cropped_SSIM_error = brisque(uint16(IBMS1_est_cropped)) / brisque(uint16(IBMS1_gt));
%     IBMS1_cropped_est_SSIM_error = brisque(uint16(IBMS1_cropped_est)) / brisque(uint16(IBMS1_gt));
    
%     IBMS1_est_cropped_SSIM_error = sum(abs(xcorr2(IBMS1_est_cropped,IBMS1_gt)),'all');
%     IBMS1_cropped_est_SSIM_error = sum(abs(xcorr2(IBMS1_cropped_est,IBMS1_gt)),'all');
    
%     points1 = detectSURFFeatures(uint16(IBMS1_gt),'MetricThreshold',0);
%     points2 = detectSURFFeatures(uint16(IBMS1_est_cropped),'MetricThreshold',0);
%     points3 = detectSURFFeatures(uint16(IBMS1_cropped_est),'MetricThreshold',0);
% 
%     [desc1, locs1]  = extractFeatures(uint16(IBMS1_gt), points1);
%     [desc2, locs2]  = extractFeatures(uint16(IBMS1_est_cropped), points2);
%     [desc3, locs3]  = extractFeatures(uint16(IBMS1_cropped_est), points3);
%     threshold=0.5;
%     IBMS1_est_cropped_SSIM_error = length(matchFeatures(desc1, desc2, 'MatchThreshold', 10.0, 'MaxRatio', threshold));
%     IBMS1_cropped_est_SSIM_error = length(matchFeatures(desc1, desc3, 'MatchThreshold', 10.0, 'MaxRatio', threshold));

    
    IBMS1_SSIM_error_cropped=[IBMS1_SSIM_error_cropped,IBMS1_est_cropped_SSIM_error];
    IBMS1_SSIM_cropped_error=[IBMS1_SSIM_cropped_error,IBMS1_cropped_est_SSIM_error];
    %MI 
    
    IBMS1_est_cropped_MI_error = mutInfo(IBMS1_est_cropped,IBMS1_gt);
    IBMS1_cropped_est_MI_error = mutInfo(IBMS1_cropped_est,IBMS1_gt);
    

    IBMS1_MI_error_cropped=[IBMS1_MI_error_cropped,IBMS1_est_cropped_MI_error];
    IBMS1_MI_cropped_error=[IBMS1_MI_cropped_error,IBMS1_cropped_est_MI_error];
    
    % IBMS1 Visualization
    if visualize && i==1
        figure('name','IBMS1')
        montage({uint16(IBMS1_gtNorm),uint16(IBMS1_est_cropped_Norm), uint16(IBMS1_cropped_est_Norm),uint16(65535-IBMS1_gt),uint16(abs(IBMS1_est_cropped_RMSE_error_image)),uint16(abs(IBMS1_cropped_est_RMSE_error_image)),uint16(IBMS1_est_cropped),IBMS1_est_cropped_SSIM_map,IBMS1_cropped_est_SSIM_map},'Size',[3 3]);
%         figure('name','Histogram Gt')
%         histogram(IBMS1_gtNorm)
%         figure('name','Histogram Cropped Depth')
%         histogram(IBMS1_cropped_est)
%         figure('name','Histogram Depth of Cropped')
%         histogram(IBMS1_est_cropped)
    end
      
end

%% IBMS1 ERROR VISUALIZATION
figure('Name','IBMS1')
subplot(2,2,1);
bar(1:length(IBMS1_RMSE_error_cropped),IBMS1_RMSE_error_cropped,'g');
hold on
bar(1:length(IBMS1_RMSE_cropped_error),IBMS1_RMSE_cropped_error, 'r');
title(sprintf('RMSE Performance: %0.1f',length(find(IBMS1_RMSE_error_cropped < IBMS1_RMSE_cropped_error))/length(IBMS1_gtlist)*100));

subplot(2,2,2);
bar(1:length(IBMS1_PSNR_error_cropped),IBMS1_PSNR_error_cropped,'g');
hold on
bar(1:length(IBMS1_PSNR_cropped_error),IBMS1_PSNR_cropped_error, 'r');
title(sprintf('PSNR Performance: %0.1f',length(find(IBMS1_PSNR_error_cropped < IBMS1_PSNR_cropped_error))/length(IBMS1_gtlist)*100));

subplot(2,2,3);
bar(1:length(IBMS1_SSIM_error_cropped),IBMS1_SSIM_error_cropped,'g');
hold on
bar(1:length(IBMS1_SSIM_cropped_error),IBMS1_SSIM_cropped_error, 'r');
title(sprintf('SSIM Performance: %0.1f',length(find(IBMS1_SSIM_error_cropped > IBMS1_SSIM_cropped_error))/length(IBMS1_gtlist)*100));

subplot(2,2,4);
bar(1:length(IBMS1_MI_error_cropped),IBMS1_MI_error_cropped,'g');
hold on
bar(1:length(IBMS1_MI_cropped_error),IBMS1_MI_cropped_error, 'r');
title(sprintf('MI Performance: %0.1f',length(find(IBMS1_MI_error_cropped > IBMS1_MI_cropped_error))/length(IBMS1_gtlist)*100));




    